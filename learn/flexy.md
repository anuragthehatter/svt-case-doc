# Flexy (Internal)

Flexy is a [Jenkins job](https://openshift-qe-jenkins.rhev-ci-vms.eng.rdu2.redhat.com/job/Launch%20Environment%20Flexy/)
which generates OC cluster. It runs a ruby script on a Jenkins slave.

* [Mojo1](https://mojo.redhat.com/docs/DOC-1125835)
* [Mojo2](https://mojo.redhat.com/docs/DOC-1074220)


## Parameters and tasks in the ruby script

* [yaml config](http://git.app.eng.bos.redhat.com/git/openshift-misc.git/plain/v3-launch-templates/system-testing/aos-36/aws/vars.ose36-aws-svt.yaml) set up parameters for the ruby script.

* Tasks:
  * Apply for subdomain
  * Host provisioning: based on the AMI specified by <code>${LAUNCHER_VARS}.image</code>
  * Installation: 2 playbooks.

Follow the [steps](manual_cluster.md) to create a cluster manually if flexy is not available.

## Debugging for flexy

### Flexy failed to run playbooks

The commands to rerun the playbooks are [here](manual_cluster.md) using the inventory files in the output of Jenkins build output.

```
["ansible-playbook", "-v", "-i", "/home/slave1/workspace/Launch Environment Flexy/workdir/OS1-install36-1-0/inventory.aos-ansible", "/home/slave1/workspace/Launch Environment Flexy/private-aos-ansible/playbooks/aws_install_prep.yml"]
```

```
["ansible-playbook", "-v", "-i", "/home/slave1/workspace/Launch Environment Flexy/workdir/OS1-install36-1-0/inv.ose34-aws-svt", "/home/slave1/workspace/Launch Environment Flexy/private-openshift-ansible/playbooks/byo/config.yml"]
```

### Failed on some ansible task

Try to search it in [bugzilla](bugzalla.md)


### SSH to Jenkins slave

#### Get slave IP
Click on the output of Jenkins build.

#### SSH

```sh
$ ssh -i ~/.ssh/libra.pem root@<slave_ip>
```
## Control size of volumes for instances

<code>${CUCUSHIFT_CONFIG}</code>

### EBS volumes

```
...
    create_opts:
      ...
      block_device_mappings:
      - device_name: /dev/sda1
        ebs:
          volume_size: 50
          volume_type: gp2
      - device_name: /dev/sdb
        ebs:
          volume_size: 300
          volume_type: gp2
```

### IOPS volumes

```
...
      instance_type: m4.xlarge
      block_device_mappings:
      - device_name: /dev/sdb
        ebs:
          volume_size: 80
          volume_type: io1
          iops: 2400
```

## Setup playbooks in Flexy
The first line in [the parameter template](template: http://git.app.eng.bos.redhat.com/git/openshift-misc.git/plain/v3-launch-templates/system-testing/aos-36/aws/template.ose36-aws-svt) is usually [the erb template](http://git.app.eng.bos.redhat.com/git/openshift-misc.git/plain/v3-launch-templates/system-testing/aos-36/aws/template.ose36-aws-svt) which defines at the bottom the playbooks with inventory file Flexy runs.

### pbench-controller
pbench-controller is another role like master, node. See [this parameter template](http://git.app.eng.bos.redhat.com/git/openshift-misc.git/plain/v3-launch-templates/system-testing/aos-36/aws/vars-pbench-controller.ose36-aws-svt.yaml) for details.

It is used for creating a testing/client node where it is expected the run tests. The pbench is registered with the cluster generated by Flexy.

### All-in-one

#### Flexy
Use [this var-template](http://git.app.eng.bos.redhat.com/git/openshift-misc.git/plain/v3-launch-templates/functionality-testing/aos-36/vars-aws/vars.ose36-rpm-rhel7-s3_registry-aws-all_in_one) and overwrite this variable <code>image: ocp-3.6.173.0.5-1-rhel-gold-auto</code>. Also note that we could use <code>auth_type: allowall</code> to allow all users to login on the web console.

Note that the above env. seems not working for [federation](federation.md) and aws config is not configured and etcd service is not available. However, objects can be created without problems. It is required to test further this env.

#### Manual cluster
Check [here](manual_cluster.md).

### Cluster version 3.5

* Use [parameter template for version 3.5](http://git.app.eng.bos.redhat.com/git/openshift-misc.git/plain/v3-launch-templates/system-testing/aos-35/aws/vars.ose35-aws-svt.yaml)
* <code>LAUNCHER_VARS</code>

```
aos_ansible_vars:
  aos_repo: https://mirror.openshift.com/enterprise/enterprise-3.5/latest/RH7-RHAOS-3.5/x86_64/os
```


### Cluster version 3.7

* Use [parameter template for version 3.7](http://git.app.eng.bos.redhat.com/git/openshift-misc.git/plain/v3-launch-templates/system-testing/aos-37/aws/vars.ose37-aws-svt.yaml)

#### Overlay2

AMI: ocp-3.7.0-0.126.4-ol2-rhel-gold-auto

```sh
# docker info
...
Storage Driver: overlay2
...

# df -hT
Filesystem                             Type      Size  Used Avail Use% Mounted on
...
/dev/mapper/docker_vg-docker--root--lv xfs        30G  2.6G   28G   9% /var/lib/docker
...

# docker info
...
Server Version: 1.12.6
Storage Driver: overlay2
 Backing Filesystem: xfs
Logging Driver: journald
...
```

#### Atomic Host

##### AH + system containers

```
image: ocp-3.7.0-0.127.0-1-atomic-gold
...
openshift_ansible_vars:
  openshift_use_system_containers: true
  system_images_registry: registry.ops.openshift.com
```

Params' meaning is [here](https://github.com/openshift/openshift-ansible/blob/master/inventory/byo/hosts.ose.example#L50).


##### AH + docker containers

```
image: ocp-3.7.0-0.127.0-1-atomic-gold
...
containerized: true
...
openshift_ansible_vars:
  openshift_use_system_containers: false
...
```

Checking:

```sh
# docker ps 
CONTAINER ID        IMAGE                                   COMMAND                  CREATED             STATUS              PORTS               NAMES
47b12564f2f7        openshift3/node:v3.7.0                  "/usr/local/bin/origi"   6 minutes ago       Up 6 minutes                            atomic-openshift-node
e5dc3f97fe3b        openshift3/openvswitch:v3.7.0           "/usr/local/bin/ovs-r"   8 minutes ago       Up 8 minutes                            openvswitch
96c78add8afb        openshift3/ose:v3.7.0                   "/usr/bin/openshift s"   11 minutes ago      Up 11 minutes                           atomic-openshift-master-controllers
2dc027f6e936        openshift3/ose:v3.7.0                   "/usr/bin/openshift s"   11 minutes ago      Up 11 minutes                           atomic-openshift-master-api
b126293639a9        registry.access.redhat.com/rhel7/etcd   "/usr/bin/etcd"          11 minutes ago      Up 11 minutes                           etcd_container

```

##### AH + cri-o

```
openshift_ansible_vars:
  openshift_use_crio: true
  openshift_crio_systemcontainer_image_override: registry.ops.openshift.com/openshift3/cri-o:latest
```

##### openshift_clusterid

```sh
ec2_tags: qe-hongkliu-flexy-aws
...
openshift_ansible_vars:
  openshift_clusterid: qe-hongkliu-flexy-aws
```
